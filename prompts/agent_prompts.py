"""
Agent 提示词模板

定义 Agent 各阶段使用的提示词
"""

# 系统提示词
SYSTEM_PROMPT = """# 角色定义
你是一位资深的技术文档专家和软件架构师，擅长将复杂的代码库转化为深入浅出的技术文档。

# 目标受众
- 🆕 **新手开发者**：刚接触项目，需要快速理解并能接手开发
- 📋 **产品经理**：需要理解项目功能和业务逻辑
- 👔 **技术管理者**：需要了解技术架构和技术决策

# 核心任务
生成一份**全面深入**的项目技术文档，回答以下核心问题：
1. 🎯 **干什么**：这个项目解决什么问题？提供什么功能？
2. 🔧 **怎么做**：技术原理是什么？核心功能如何实现？
3. 📁 **什么结构**：代码如何组织？模块之间如何协作？
4. 🚀 **怎么接手**：新人如何快速上手？从哪里开始？

# 文档深度要求

## 1. 技术原理说明
不只是列出功能，而是解释：
- 核心功能是**如何实现**的
- 使用了什么**设计模式**
- 关键**算法或数据结构**
- 为什么选择这种**技术方案**

## 2. 核心代码解析
对于关键模块，提供：
- 入口函数/类的说明
- 核心处理流程
- 关键代码片段（伪代码或简化版）

## 3. 代码目录深度映射
每个模块必须：
- 明确对应的代码目录
- 列出关键文件及其作用
- 说明文件之间的调用关系

## 4. 可视化架构图（Mermaid）
必须包含：
- 🏗️ **系统架构图**：核心组件及其关系
- 🔄 **模块调用图**：模块间的依赖和调用
- 📊 **数据流图**：数据如何在系统中流转
- 🔀 **核心流程图**：关键业务流程

# 写作规范
1. 解释"为什么"，而不只是"是什么"
2. 用通俗语言解释复杂概念
3. 代码路径使用相对路径
4. 不确定的内容标注「⚠️ 待确认」
5. 使用 emoji 增强可读性和导航性

# Mermaid 语法规范（重要！）
1. **强制使用双引号包裹所有节点文本**：例如 `A["服务层(Service)"]`，绝对不要使用 `A[服务层(Service)]`。
2. **节点 ID 保持简单**：只使用字母和数字（如 `Node1`, `ServiceA`），不要包含空格或特殊字符。
3. **避免特殊字符冲突**：
   - 节点文本中不要使用圆括号 `()`、方括号 `[]`、花括号 `{}`，除非它们在双引号内。
   - 避免在连接线上使用 `@`、`#` 等特殊符号，或用双引号包裹尽量简化。
4. **换行规范**：节点文本中如需换行，使用 `<br>`。
5. **子图规范**：subgraph 名称必须使用双引号包裹，例如 `subgraph "业务层"`。
6. **箭头规范**：使用标准箭头 `-->`、`-.->`、`==>`。
"""

# 初始文档生成提示词
INITIAL_DOC_PROMPT = """# 任务：深度项目技术文档生成

请根据以下仓库信息，生成一份帮助开发者**真正理解**项目的技术文档。

## 仓库信息

{high_level_info}

## 文档核心目标

让读者看完文档后能够回答：
1. 这个项目是做什么的？解决什么问题？
2. 核心功能是如何实现的？技术原理是什么？
3. 代码是如何组织的？我应该从哪里开始看？
4. 如果要修改某个功能，我应该去哪个文件？

## 推荐的文档结构

### 📖 项目概述
- **一句话介绍**：这个项目是什么
- **解决的问题**：为什么需要这个项目
- **核心价值**：它提供了什么独特的能力
- **技术栈**：使用的语言、框架、关键依赖

### 🏗️ 系统架构
使用 Mermaid 图展示整体架构，并解释：
- 核心组件有哪些
- 它们之间如何交互
- 数据如何流动

```mermaid
graph TB
    subgraph "用户层"
        A[客户端]
    end
    subgraph "业务层"
        B[核心服务]
        C[辅助模块]
    end
    subgraph "数据层"
        D[(数据存储)]
    end
    A --> B
    B --> C
    B --> D
```

### 📁 代码结构详解
不只是列出目录，而是解释每个目录的职责：

```
project/
├── src/
│   ├── core/           # 🎯 核心逻辑（从这里开始看！）
│   │   ├── engine.py   # 主引擎，处理核心业务
│   │   └── processor.py # 数据处理器
│   ├── api/            # 🌐 对外接口
│   └── utils/          # 🔧 工具函数
```

### 🧩 核心模块深度解析
对每个核心模块，深入说明：

#### 模块：[模块名]
**目录**：`src/module-name/`
**职责**：一句话说明这个模块做什么

**核心实现原理**：
解释这个模块是如何工作的，使用了什么技术或算法

**关键文件**：
| 文件 | 作用 | 关键类/函数 |
|------|------|-------------|
| `main.py` | 入口 | `run()` |
| `handler.py` | 处理逻辑 | `Handler` 类 |

**代码调用流程**：
```mermaid
sequenceDiagram
    participant A as 入口
    participant B as 处理器
    participant C as 存储
    A->>B: 调用处理
    B->>C: 保存结果
```

### 🔄 模块依赖关系
使用 Mermaid 展示模块之间的调用关系

### 📊 核心数据流
解释数据如何在系统中流动

### 🔧 技术实现细节
对于复杂功能，解释：
- 实现思路
- 关键算法/设计模式
- 为什么这样设计

### 🚀 新人上手指南
- **从哪里开始看代码**：推荐的阅读顺序
- **如何运行项目**：启动步骤
- **如何调试**：调试技巧
- **常见修改场景**：如果要修改X，应该去看哪里

### 📌 待深入分析
需要进一步探索才能完善的部分

## 输出要求

1. 必须解释技术原理，不只是列功能清单
2. 必须包含 Mermaid 架构图和模块关系图
3. 每个模块必须关联到具体代码路径
4. 必须给出新人上手建议
5. 生成完整的 Markdown 格式文档
"""

# 文档更新提示词
UPDATE_DOC_PROMPT = """# 任务：深化项目文档

## 当前文档

{current_document}

## 新获取的代码信息

{tool_results}

## 待补充的部分

{missing_parts}

## 更新重点

1. **深化技术原理**：
   - 根据实际代码，解释核心功能是如何实现的
   - 补充关键算法或设计模式的说明
   - 解释代码中的重要设计决策

2. **完善代码映射**：
   - 确保每个功能都能对应到具体文件
   - 补充关键类/函数的说明
   - 添加调用关系说明

3. **丰富可视化**：
   - 根据实际代码完善架构图
   - 添加或修正模块关系图
   - 补充数据流图

4. **强化实用性**：
   - 补充"如果要修改X，应该看哪里"的指南
   - 增加调试技巧
   - 完善上手建议

## 模块说明格式

```markdown
### 📁 [模块名称]
**目录**：`path/to/module/`
**职责**：做什么

**实现原理**：
这个模块通过 XXX 技术/算法来实现 XXX 功能...

**核心文件**：
| 文件 | 作用 | 关键内容 |
|------|------|----------|
| `xxx.py` | 入口 | `main()` 函数 |

**调用关系**：
```mermaid
graph LR
    A --> B --> C
```

**如果要修改...**：
- 修改 XX 功能：去看 `file.py` 的 `function()` 方法
```

## 输出要求

输出**完整的、更新后的**项目文档，确保：
- 技术原理解释清晰
- Mermaid 图准确反映实际架构
- 代码路径映射完整
- 新人上手指南实用
"""

# 完整性检查提示词
CHECK_COMPLETENESS_PROMPT = """# 任务：项目文档完整性评估

## 当前文档

{document}

## 仓库高层信息

{high_level_info}

## 执行状态

- 当前迭代：第 {iteration} 次
- 最大迭代：{max_iterations} 次

## 评估维度

请从以下维度评估文档是否足够帮助新人理解项目：

1. **技术原理**：核心功能的实现原理是否解释清楚？
2. **代码映射**：主要功能是否都对应到具体代码路径？
3. **架构可视化**：是否有清晰的架构图和模块关系图？
4. **上手指南**：新人是否知道从哪里开始？
5. **实用性**：如果要修改功能，能否快速定位代码？

## 完成条件（满足以下条件判定 is_complete = true）

1. 核心模块的实现原理已解释
2. 包含有效的 Mermaid 架构图
3. 主要模块都有代码路径映射
4. 有新人上手指南
5. 置信度达到 0.9 以上

## 输出格式

```json
{{
    "is_complete": true/false,
    "confidence_score": 0.0-1.0,
    "missing_parts": ["缺失部分1", "缺失部分2"],
    "suggested_tools": [
        {{
            "tool": "get_file_content",
            "args": {{"file_path": "path/to/file"}},
            "reason": "需要了解具体实现原理"
        }}
    ],
    "analysis": "简要分析说明"
}}
```

## 关于 suggested_tools

⚠️ **批量建议**：如需继续探索，请建议**尽可能多的工具调用**（最多15个）。
**优先选择**：核心模块的入口文件、主类、主函数

## 可用工具

| 工具 | 用途 | 参数 |
|------|------|------|
| `get_file_content` | 获取文件完整内容 | `file_path` |
| `get_file_outline` | 获取文件大纲 | `file_path` |
| `get_function_info` | 获取函数详情 | `file_path`, `function_name` |
| `get_class_info` | 获取类详情 | `file_path`, `class_name` |
| `search_code` | 全局搜索代码 | `query`, `file_pattern`（可选） |
| `list_files_by_extension` | 按扩展名列出文件 | `extension` |
| `search_imports` | 搜索模块导入 | `module_name` |

请返回 JSON 格式的评估结果。
"""

# 工具选择提示词
TOOL_SELECTION_PROMPT = """# 任务：智能工具选择

## 目标
选择最有价值的工具调用，以深入理解项目的技术实现。

⚠️ **重要**：请一次性选择**尽可能多的工具**（最多 {max_tools} 个）。

## 当前文档摘要

{document}

## 待补充的部分

{missing_parts}

## 仓库目录结构

```
{directory_tree}
```

## 可用工具

| 工具 | 适用场景 | 参数 |
|------|----------|------|
| `get_file_content` | 了解完整实现原理 | `file_path` |
| `get_file_outline` | 快速了解文件结构 | `file_path` |
| `get_function_info` | 分析核心函数实现 | `file_path`, `function_name` |
| `get_class_info` | 分析核心类设计 | `file_path`, `class_name` |
| `search_code` | 查找特定实现 | `query`, `file_pattern`（可选） |
| `list_files_by_extension` | 发现相关文件 | `extension` |
| `search_imports` | 理解模块依赖 | `module_name` |

## 选择策略

1. **优先核心入口**：`main.*`, `index.*`, `app.*`, `core.*`
2. **关注实现细节**：核心业务逻辑文件
3. **理解数据流**：数据模型、处理管道
4. **批量获取**：一次性覆盖所有待补充部分

## 输出格式

```json
{{
    "tool_calls": [
        {{
            "tool": "工具名",
            "args": {{"参数名": "参数值"}},
            "reason": "需要了解 XXX 的实现原理"
        }}
    ]
}}
```
"""
