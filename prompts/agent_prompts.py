"""
Agent 提示词模板

定义 Agent 各阶段使用的提示词
"""

# 系统提示词
SYSTEM_PROMPT = """# 角色定义
你是一位资深的软件架构师和需求分析专家，擅长通过代码逆向工程推导软件需求规格说明书（SRS）。

# 核心任务
根据提供的代码库源代码，生成一份专业、完整的软件需求规格说明书。

# 输出规范

## 1. 项目概述
- **项目名称**：从代码或配置中提取
- **项目简介**：50-100字的核心描述
- **技术栈**：使用的编程语言、框架、数据库等
- **目标用户**：主要使用者群体

## 2. 功能需求（按模块组织）
对每个功能模块：
- **模块名称**：清晰的模块标识
- **功能描述**：该模块的主要职责
- **核心功能点**：具体功能列表（使用编号）
- **业务规则**：相关的业务逻辑约束
- **依赖关系**：与其他模块的交互

## 3. 数据模型
- **核心实体**：实体名称、属性、数据类型
- **实体关系**：实体之间的关联（一对一、一对多等）
- **数据约束**：必填字段、唯一性、外键等

## 4. 接口设计（如有）
- **API 端点**：路径、方法、参数
- **请求/响应格式**
- **认证方式**

## 5. 业务流程
- **核心流程**：用户操作的主要路径
- **状态转换**：关键状态及其转换条件

## 6. 非功能需求
- **性能要求**：并发、响应时间等
- **安全机制**：认证、授权、加密
- **可扩展性**：设计上的扩展考虑

# 写作规范
1. 使用专业、准确的中文技术术语
2. 基于代码实际内容推断，不臆造功能
3. 无法确定的内容标注「⚠️ 待确认」
4. 保持层次清晰，使用Markdown格式
5. 功能描述应具体可测试
"""

# 初始文档生成提示词
INITIAL_DOC_PROMPT = """# 任务：初始需求文档生成

请根据以下仓库的高层信息，生成需求规格说明书的初版。

## 仓库信息

{high_level_info}

## 分析策略

1. **从 README 提取**：项目目标、核心功能、使用方法
2. **从目录结构推断**：模块划分、架构设计
3. **从配置文件了解**：技术栈、依赖、运行环境
4. **从命名规范识别**：业务领域、数据实体

## 输出要求

1. 建立完整的文档结构框架
2. 填充所有可确定的信息
3. 对于需要深入分析的部分，标注「📌 待深入分析」
4. 生成完整的 Markdown 格式文档
"""

# 文档更新提示词
UPDATE_DOC_PROMPT = """# 任务：需求文档增量更新

## 当前文档状态

{current_document}

## 新获取的代码信息

{tool_results}

## 之前识别的待补充部分

{missing_parts}

## 更新策略

1. **保留**：已有的准确内容必须保留
2. **补充**：新发现的功能和实体添加到对应章节
3. **修正**：发现冲突时更新为更准确的描述
4. **细化**：将「待确认」「待深入分析」改为确定内容

## 输出要求

输出**完整的、更新后的**需求文档，包含：
- 所有之前的有效内容
- 本次新发现的功能和实体
- 任何必要的修正和细化

## 重要提示
请充分利用新获取的所有信息更新文档
"""

# 完整性检查提示词
CHECK_COMPLETENESS_PROMPT = """# 任务：需求文档完整性评估

## 当前文档

{document}

## 仓库高层信息

{high_level_info}

## 执行状态

- 当前迭代：第 {iteration} 次
- 最大迭代：{max_iterations} 次

## 评估标准

⚠️ **重要**：为了减少不必要的迭代和 token 消耗，请遵循以下原则：

1. **小型项目**（<50个源文件）：2-3次迭代后应判定完成
2. **中大型项目**（50-200个源文件）：3-5次迭代后应判定完成

## 完成条件（满足以下任一即可判定 is_complete = true）

1. 主要功能模块已识别并描述
2. 核心数据实体已定义
3. 达到最大迭代次数
4. 置信度达到0.9以上

## 输出格式

请以 JSON 格式返回评估结果：

```json
{{
    "is_complete": true/false,
    "confidence_score": 0.0-1.0,
    "missing_parts": ["缺失部分1", "缺失部分2"],
    "suggested_tools": [
        {{
            "tool": "get_file_content",
            "args": {{"file_path": "path/to/file"}},
            "reason": "需要了解具体实现"
        }}
    ],
    "analysis": "简要分析说明"
}}
```

## 关于 suggested_tools

⚠️ **批量建议工具**：如果需要继续探索，请 **尽可能多的工具调用**（最多15个），以减少迭代次数。

## 可用工具

| 工具 | 用途 | 参数 |
|------|------|------|
| `get_file_content` | 获取文件完整内容 | `file_path`（相对于仓库根目录） |
| `get_file_outline` | 获取文件大纲（类和函数列表） | `file_path`（相对于仓库根目录） |
| `get_function_info` | 获取函数详情（签名、文档、源码） | `file_path`, `function_name` |
| `get_class_info` | 获取类详情（继承、方法、属性） | `file_path`, `class_name` |
| `search_code` | 全局搜索代码 | `query`（搜索词）, `file_pattern`（可选，如 "*.py"） |
| `list_files_by_extension` | 按扩展名列出文件 | `extension`（如 ".java"） |
| `search_imports` | 搜索特定模块的导入 | `module_name` |

请返回 JSON 格式的评估结果。
"""

# 工具选择提示词
TOOL_SELECTION_PROMPT = """# 任务：智能工具选择

## 目标
选择最有价值的工具调用，以高效补充需求文档的缺失部分。

⚠️ **重要**：请一次性选择 **尽可能多的工具**（最多 {max_tools} 个），以减少迭代次数和 token 消耗。

## 当前文档摘要

{document}

## 待补充的部分

{missing_parts}

## 仓库目录结构

```
{directory_tree}
```

## 可用工具

| 工具 | 适用场景 | 参数 |
|------|----------|------|
| `get_file_content` | 需要了解完整实现逻辑 | `file_path`（相对于仓库根目录的路径） |
| `get_file_outline` | 快速了解文件结构 | `file_path`（相对于仓库根目录的路径） |
| `get_function_info` | 深入分析特定函数 | `file_path`, `function_name` |
| `get_class_info` | 分析类的属性和方法 | `file_path`, `class_name` |
| `search_code` | 跨文件搜索特定模式 | `query`（搜索词）, `file_pattern`（可选，如 "*.java"） |
| `list_files_by_extension` | 发现特定类型的文件 | `extension`（文件扩展名，如 ".py"） |
| `search_imports` | 查找特定模块的使用 | `module_name` |

## 选择策略

1. **批量选择**：一次性选择多个工具，覆盖所有缺失部分
2. **优先级**：先选 `get_file_outline` 了解结构，再选 `get_file_content` 和 `get_class_info` 深入分析
3. **效率优先**：优先选择能填补最大空白的工具

## 输出格式

请选择 **{max_tools} 个**工具调用，以 JSON 格式返回：

```json
{{
    "tool_calls": [
        {{
            "tool": "工具名",
            "args": {{"参数名": "参数值"}},
            "reason": "选择此工具的理由"
        }}
    ]
}}
```

## 参数说明

- `file_path`: 使用相对于仓库根目录的路径，如 "src/main/java/App.java"
- `extension`: 包含点号，如 ".java"、".py"、".ts"
- `query`: 搜索关键词
- `function_name` / `class_name`: 函数或类的名称（不含路径）
"""
